<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title> Negative Sampling (in Numpy) </title>

        <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Negative Sampling (in Numpy) | HBC Tech</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Negative Sampling (in Numpy)" />
<meta name="author" content="Jason Tam" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Alright, time to have some fun exploring efficient negative sampling implementations in NumPy…" />
<meta property="og:description" content="Alright, time to have some fun exploring efficient negative sampling implementations in NumPy…" />
<link rel="canonical" href="https://tech.hbc.com/2018-03-23-negative-sampling-in-numpy.html" />
<meta property="og:url" content="https://tech.hbc.com/2018-03-23-negative-sampling-in-numpy.html" />
<meta property="og:site_name" content="HBC Tech" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-03-23T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Jason Tam" />
<script type="application/ld+json">
{"description":"Alright, time to have some fun exploring efficient negative sampling implementations in NumPy…","author":{"@type":"Person","name":"Jason Tam"},"@type":"BlogPosting","url":"https://tech.hbc.com/2018-03-23-negative-sampling-in-numpy.html","headline":"Negative Sampling (in Numpy)","dateModified":"2018-03-23T00:00:00-05:00","datePublished":"2018-03-23T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tech.hbc.com/2018-03-23-negative-sampling-in-numpy.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

        <meta property="og:title" content="Negative Sampling (in Numpy)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tech.hbc.com//2018-03-23-negative-sampling-in-numpy.html" />
<meta property="og:description" content="Alright, time to have some fun exploring efficient negative sampling implementations in NumPy…" />
<meta property="og:image" content="https://tech.hbc.com/assets/images/blog/hbc-tech-logo-tipi.jpg" />
<meta property="og:image:secure_url" content="https://tech.hbc.com/assets/images/" />
<meta property="og:image:type" content="image/jpeg" />
<meta property="og:image:alt" content="" />


        <link rel="stylesheet" href="https://tech.hbc.com/assets/css/main.css">
        <link rel="canonical" href="https://tech.hbc.com/2018-03-23-negative-sampling-in-numpy.html">
        <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet">

        <!-- Icons -->
        <!-- 16x16 -->
        <link rel="shortcut icon" href="https://tech.hbc.com/assets/images/favicon.ico">
    </head>

    <body aria-label="Content">
        <header id="site-header" class="site-header">
    <div class="site-header__inner">
    	<a class="site-header__logo" href="/">
        	<svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 52">
        		<use class="hbc-tech-logo__text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#hbc-tech-logo"></use>
            </svg>
    	</a>
        <nav id="menu" class="navigation">
    <svg class="navigation__menu-icon" xmlns="http://www.w3.org/2000/svg">
        <path class="bar bar__top" d="M0,3 L30,3" />
        <path class="bar bar__cross-1" d="M0,14 L30,14" />
        <path class="bar bar__cross-2" d="M0,14 L30,14" />
        <path class="bar bar__bottom" d="M0,25 L30,25" />
    </svg>
	<menu class="menu">
		<ul class="link-list">
		
        
            <li class="link-list__link-item">
                <a href="https://tech.hbc.com/" class="link-list__link
            
            ">
                <span class="link-list__link-highlight">Insights</span></a>
            </li>
        
            <li class="link-list__link-item">
                <a href="https://tech.hbc.com/code" class="link-list__link
            
            ">
                <span class="link-list__link-highlight">Code</span></a>
            </li>
        
            <li class="link-list__link-item">
                <a href="https://tech.hbc.com/about" class="link-list__link
            
            ">
                <span class="link-list__link-highlight">About</span></a>
            </li>
        
            <li class="link-list__link-item">
                <a href="https://tech.hbc.com/work-here" class="link-list__link
            
            ">
                <span class="link-list__link-highlight">Work Here</span></a>
            </li>
        
	    </ul>
	</menu>
</nav>

        <search id="header-search" class="header-search">
	<form class="header-search__form" action>
	  <input type="text" class="header-search__input" id="header-search-input" placeholder=" Search" name="query">
	</form>
  	<svg id="header-search__toggle" class="header-search__svg" xmlns="http://www.w3.org/2000/svg" >
		<path id="leftSearch" class="path path--left-half" d="M11.4842576,23.9891168 C5.09608476,23.7189967 0,18.4546255 0,12 C0,5.54951437 4.85419801,0.113423154 12.4763811,0.0114091479"/>
		<path id="rightSearch" class="path path--right-half" d="M12.5376167,0.0118279089 C18.9155446,0.293025077 24,5.55274344 24,12 C24,18.4701834 17.7604297,24.3112218 11.1896721,23.9909829"/>
		<path id="handle" class="path path--handle" d="M20.7485408,20.8914207 L26.8571202,27 L20.7485408,20.8914207"/>
    </svg>
    <section class="header-search__results" id="header-search__results"></section>
</search>

    </div>
</header>

        <section class="content"><article class="article">
    <header class="article__header article__header--reveal">
        <h1 class="header-title" title="Negative Sampling (in Numpy)">Negative Sampling (in Numpy)</h1>
        
        <span id="no-image-placeholder" class="no-image-placeholder"></span>
        

        
            
        <div class="article-meta">
            
            <a href="https://tech.hbc.com/category/data-science" class="article-meta__category">data science</a>
            
        
        
        
            <span class="slug-divider"></span>
            <span class="article-meta__author">
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Jason Tam<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            </span>
            <span class="slug-divider"></span>
        
    
            <span class="article-meta__date">
                MAR 23, 2018
            </span>
        </div>
    </header>
    <section class="article__content article__content--reveal">
        
        <div class="article__content__read-time"><span class="read-time" title="Estimated read time">
  
  
    <span class="read-time__text-1">10 min</span>
    <span class="read-time__text-2">Read</span>
    <span class="read-time__text-3">Time</span>
  
</span>
</div>
        <div class="article__content__share-buttons"><ul class="share-buttons">
    <li class="share-buttons__link-item">
        <a href="https://twitter.com/intent/tweet?text=https://tech.hbc.com//2018-03-23-negative-sampling-in-numpy.html" class="share-buttons__link" title="Share on Twitter" target="_blank">
            <svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg">
                <use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#twitter"></use>
            </svg>
        </a>
    </li>
    <li class="share-buttons__link-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://tech.hbc.com/&source=/2018-03-23-negative-sampling-in-numpy.html&title=Negative Sampling (in Numpy)" class="share-buttons__link" title="Share on Linkedin" target="_blank">
            <svg height="36" width="36" xmlns="http://www.w3.org/2000/svg">
                <use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#linkedin" ></use>
            </svg>
        </a>
    </li>
    <li class="share-buttons__link-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://tech.hbc.com//2018-03-23-negative-sampling-in-numpy.html" class="share-buttons__link" title="Share on Facebook" target="_blank">
            <svg height="36" width="36" xmlns="http://www.w3.org/2000/svg">
                <use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#facebook" ></use>
            </svg>
        </a>
    </li>
    <li class="share-buttons__link-item">
        <a href="https://www.reddit.com/submit?url=https://tech.hbc.com//2018-03-23-negative-sampling-in-numpy.html" class="share-buttons__link" title="Share on Reddit" target="_blank">
            <svg height="36" width="36" xmlns="http://www.w3.org/2000/svg">
                <use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#reddit" ></use>
            </svg>
        </a>
    </li>
</ul>
</div>
        <div class="article__content__body"><p><em>Alright, time to have some fun exploring efficient negative sampling implementations in NumPy…</em></p>

<p>Negative sampling is a technique used to train machine learning models that generally have several order of magnitudes more negative observations compared to positive ones. And in most cases, these negative observations are not given to us explicitly and instead, must be generated somehow. Today, I think the most prevalent usages of negative sampling is in training Word2Vec (or similar) and in training implicit recommendation systems (BPR). In this post, I’m going to frame the problem under the recommendation system setting — sorry NLP fans.</p>

<h1 id="problem">Problem</h1>

<p>For a given user, we have the indices of positive items corresponding to that user. These are items that the user has consumed in the past. We also know the fixed size of the entire item catalog. Oh, we will also assume that the given positive indices are ordered. This is quite a reasonable assumption because positive items are often stored in CSR interaction matrices (err… at least in the world of recommender systems).</p>

<p>And from this information, we would like to sample from the other (non-positive) items with equal probability.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_items</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pos_inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>item_ind</th>
      <th>Probability</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>2</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <td>4</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>5</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0</td>
    </tr>
    <tr>
      <td>8</td>
      <td>1/8</td>
    </tr>
    <tr>
      <td>9</td>
      <td>1/8</td>
    </tr>
  </tbody>
</table>

<h1 id="bad-ideas">Bad Ideas</h1>

<p>We could enumerate all the possible choices of negative items and then use <code class="highlighter-rouge">np.random.choice</code> (or similar). However, as there are usually orders of magnitude more negative items than positive items, this is not memory friendly.</p>

<h1 id="incremental-guess-and-check">Incremental Guess and Check</h1>

<p>As a trivial (but feasible) solution, we are going to continually sample a random item from our catalog, and keep items if they are not positive. This will continue until we have enough negative samples.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negsamp_incr</span><span class="p">(</span><span class="n">pos_check</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Guess and check with arbitrary positivity check
    """</span>
    <span class="n">neg_inds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_inds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_samp</span><span class="p">:</span>
        <span class="n">raw_samp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos_check</span><span class="p">(</span><span class="n">raw_samp</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">):</span>
            <span class="n">neg_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_samp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">neg_inds</span>
</code></pre></div></div>

<p>A major downside here is that we are sampling a single value many times — rather than sampling many values once. And although it will be infrequent, we have to re-sample if we get unlucky and randomly choose a positive item.</p>

<p>This family of strategies will pretty much only differ by how item positivity is checked. We will go through a couple of ways to tinker with the complexity of the positivity check, but keep in mind that the number of positive items is generally small, so these modifications are actually not super-duper important.</p>

<h2 id="using-in-operator-on-the-raw-list">Using <code class="highlighter-rouge">in</code> operator on the raw list:</h2>

<p>With a <code class="highlighter-rouge">list</code>, the item positivity check is O(n) as it checks every element of the list.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negsamp_incr_naive</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Guess and check with list membership
    """</span>
    <span class="n">pos_check</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">raw_samp</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">:</span> <span class="n">raw_samp</span> <span class="ow">in</span> <span class="n">pos_inds</span>
    <span class="k">return</span> <span class="n">negsamp_incr</span><span class="p">(</span><span class="n">pos_check</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="using-in-operator-on-a-set-created-from-the-list">Using <code class="highlighter-rouge">in</code> operator on a set created from the list:</h2>

<p>Here, we’re going to first convert our <code class="highlighter-rouge">list</code> into a python <code class="highlighter-rouge">set</code> which is implemented as a hashtable. Insertion is O(1), so the conversion itself is O(n). However, once the set is created, our item positivity check (set membership) will be O(1) thereon after. So we can expect this to be a nicer strategy if <code class="highlighter-rouge">n_samp</code> is large.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negsamp_incr_set</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Guess and check with hashtable membership
    """</span>
    <span class="n">pos_inds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">)</span>
    <span class="n">pos_check</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">raw_samp</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">:</span> <span class="n">raw_samp</span> <span class="ow">in</span> <span class="n">pos_inds</span>
    <span class="k">return</span> <span class="n">negsamp_incr</span><span class="p">(</span><span class="n">pos_check</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="using-a-binary-search-on-the-list-assuming-its-sorted">Using a binary search on the list (assuming it’s sorted):</h2>

<p>One of best things you can do exploit the sortedness of a list is to use binary search. All this does is change our item positivity check to O(log(n)).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_left</span>
<span class="k">def</span> <span class="nf">bsearch_in</span><span class="p">(</span><span class="n">search_val</span><span class="p">,</span> <span class="n">val_arr</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="n">val_arr</span><span class="p">,</span> <span class="n">search_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_arr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">search_val</span>
    
<span class="k">def</span> <span class="nf">negsamp_incr_bsearch</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Guess and check with binary search
    `pos_inds` is assumed to be ordered
    """</span>
    <span class="n">pos_check</span> <span class="o">=</span> <span class="n">bsearch_in</span>
    <span class="k">return</span> <span class="n">negsamp_incr</span><span class="p">(</span><span class="n">pos_check</span><span class="p">,</span> <span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="p">)</span>
</code></pre></div></div>

<p>(Aside: LightFM, a popular recommendation system implements this in Cython. They also have a good reason to implement this in a sequential fashion — but we won’t go into that.)</p>

<h2 id="vectorized-binary-search">Vectorized Binary Search</h2>

<p>Here we are going to address the issue of incremental generation. All random samples will now be generated and verified in vectorized manners. The upside here is that we will reap the benefits of NumPy’s underlying optimized vector processing. Any positives found during this check will then be masked off. A new problem arises in that if we hit any positives, we will end up returning less samples than prescribed by the <code class="highlighter-rouge">n_samp</code> parameter. Yeah, we could fill in the holes with the previously discussed strategies, but let’s just leave it at that.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negsamp_vectorized_bsearch</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Guess and check vectorized
    Assumes that we are allowed to potentially 
    return less than n_samp samples
    """</span>
    <span class="n">raw_samps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samp</span><span class="p">)</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">raw_samps</span><span class="p">)</span>
    <span class="n">pos_mask</span> <span class="o">=</span> <span class="n">raw_samps</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'clip'</span><span class="p">)</span>
    <span class="n">neg_inds</span> <span class="o">=</span> <span class="n">raw_samps</span><span class="p">[</span><span class="o">~</span><span class="n">pos_mask</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">neg_inds</span>
</code></pre></div></div>

<h2 id="vectorized-pre-verified-binary-search">Vectorized Pre-verified Binary Search</h2>

<p>Finally, we are going to address both main pitfalls of the guess-and-check strategies.</p>

<p>Vectorize: generate all our random samples at once
Pre-verify: no need for an item positivity check
We know how many negative items are available to be sampled since we have the size of our item catalog, and the number of positive items ( <code class="highlighter-rouge">len(pos_inds)</code> is just O(1) ) to subtract off. So let’s sample uniformly over a range of imaginary negative indices with 1–1 correspondence with our negative items. This gives us the correct distribution since we have the correct number of negative item slots to sample from; however, the indices now need to be adjusted.</p>

<p>To fix our imaginary index, we must add the number of positive items that precede each position. Assuming our positive indices are sorted, this is just a binary search (compliments of np.searchsorted). But keep in mind that in our search, for each positive index, we also need to subtract the number of positive items that precede each position.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">negsamp_vectorized_bsearch</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">,</span> <span class="n">n_items</span><span class="p">,</span> <span class="n">n_samp</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="s">""" Pre-verified with binary search
    `pos_inds` is assumed to be ordered
    """</span>
    <span class="n">raw_samp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_samp</span><span class="p">)</span>
    <span class="n">pos_inds_adj</span> <span class="o">=</span> <span class="n">pos_inds</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">))</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pos_inds_adj</span><span class="p">,</span> <span class="n">raw_samp</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s">'right'</span><span class="p">)</span>
    <span class="n">neg_inds</span> <span class="o">=</span> <span class="n">raw_samp</span> <span class="o">+</span> <span class="n">ss</span>
    <span class="k">return</span> <span class="n">neg_inds</span>
</code></pre></div></div>

<p>Briefly, let’s look at how this works for all possible raw sampled values.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_items</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">pos_inds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
<span class="c"># raw_samp = np.random.randint(0, n_items - len(pos_inds), size=n_samp)</span>
<span class="c"># Instead of sampling, see what happens to each possible sampled value</span>
<span class="n">raw_samp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">))</span>
<span class="n">raw_samp</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="c"># Subtract the number of positive items preceding</span>
<span class="n">pos_inds_adj</span> <span class="o">=</span> <span class="n">pos_inds</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_inds</span><span class="p">))</span>
<span class="n">pos_inds_adj</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="c"># Find where each raw sample fits in our adjusted positive indices</span>
<span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pos_inds_adj</span><span class="p">,</span> <span class="n">raw_samp</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s">'right'</span><span class="p">)</span>
<span class="n">ss</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="c"># Adjust our raw samples</span>
<span class="n">neg_inds</span> <span class="o">=</span> <span class="n">raw_samp</span> <span class="o">+</span> <span class="n">ss</span>
<span class="n">neg_inds</span><span class="p">:</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span>
</code></pre></div></div>

<p>As desired, each of our sampled values has a 1–1 mapping to a negative item.</p>

<h2 id="summary-notebook-with-results">Summary Notebook with Results</h2>

<p>The notebook linked below compares the implementations discussed in this post in some example scenarios. The previously discussed “Vectorized Pre-verified Binary Search” strategy seems to be the most performant except in the edge case where <code class="highlighter-rouge">n_samp=1</code> where vectorization no longer pays off (in that case, all strategies are very close).</p>

<p><a href="https://gist.github.com/JasonTam/89ff752d7e35ec17d730c87aea96c19b#file-neg_samp_experiments-ipynb">Notebook with results</a></p>

<h2 id="concluding-remarks">Concluding Remarks</h2>

<p>In models that require negative sample, the sample stage is often a bottleneck in the training process. So even little optimizations like this are pretty helpful.</p>

<p>Some further thinking:</p>

<ul>
  <li>how to efficiently sample for many users at a time (variable length number of positive items)</li>
  <li>at what point (sparsity of our interaction matrix) does our assumption that <code class="highlighter-rouge">n_neg_items &gt;&gt; n_pos_items</code> wreck each implementation</li>
  <li>how easy is it to modify each implementation to accommodate for custom probability distributions — if we wanted to take item frequency or expose into account</li>
</ul>
</div>
        <footer class="article__content__footer">
            
<div class="article-tags">

    <span class="article-tags__tag">numpy</span><span>,</span>
    

    <span class="article-tags__tag">sampling</span><span>,</span>
    

    <span class="article-tags__tag">python</span><span>,</span>
    

    <span class="article-tags__tag">algorithms</span>

</div>


            <!-- author bio -->
<section class="author-bio">


	

	
	<!-- author is a guest contributor -->
	<svg class="author-bio__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg">
        <use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#circle" ></use>
        <use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#head" ></use>
        <use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#body" ></use>
    </svg>
	<span class="author-bio__name">Jason Tam</span>
	


</section>

        </footer>
    </section>
    <aside class="recirc">
    <h2 class="header__title">Recent Insights</h2><span class="slug-divider"></span>
    <a class="header__view-all-link" href="https://tech.hbc.com/categories/index.html">See All</a>
    <div class="recirc__articles">
    
    
    
    
    
    

    
        
            
        <article class="recirc__articles__item">
            


<section class="snippet">

    
    <h1 class="snippet__title">
    <a href="https://tech.hbc.com/2018-05-07-experimental-reproducibility-in-data-science.html" class="snippet__title__link" title="ODSC Workshop on Experimental Reproducibility in Data Science">
        ODSC Workshop on Experimental Reproducibility in Data Science
    </a>
    </h1>
    <div class="snippet__meta">
    
        
        
        
            

            
                <a class="meta__category-link" href="https://tech.hbc.com/category/data-science">data science</a>
            

            <span class="slug-divider"></span>
        
    

    
        
            <span class="meta__author">
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Karthik Rajasethupathy<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                <span>,</span>
                
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Jason Tam<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            </span>
            <span class="slug-divider"></span>
        
    
    
        <span class="meta__date">MAY 7, 2018</span>
    
    </div>
    
        <a href="https://tech.hbc.com/2018-05-07-experimental-reproducibility-in-data-science.html" class="snippet__excerpt__link" title="ODSC Workshop on Experimental Reproducibility in Data Science">
            <p class="snippet__excerpt">
            On May 2nd, we presented at the Open Data Science Conference in Boston, MA. We demonstrated
how to build a machine learning project from scratch with Sacred, an open source
library for experiment tracking, and how to view the results using
Sacredboard.


            </p>
        </a>
    
</section>

        </article>
        
    
        
    
        
            
        <article class="recirc__articles__item">
            


<section class="snippet">

    
    <h1 class="snippet__title">
    <a href="https://tech.hbc.com/2018-05-07-experimental-reproducibility-in-data-science.html" class="snippet__title__link" title="ODSC Workshop on Experimental Reproducibility in Data Science">
        ODSC Workshop on Experimental Reproducibility in Data Science
    </a>
    </h1>
    <div class="snippet__meta">
    
        
        
        
            

            
                <a class="meta__category-link" href="https://tech.hbc.com/category/data-science">data science</a>
            

            <span class="slug-divider"></span>
        
    

    
        
            <span class="meta__author">
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Karthik Rajasethupathy<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                <span>,</span>
                
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Jason Tam<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            </span>
            <span class="slug-divider"></span>
        
    
    
        <span class="meta__date">MAY 7, 2018</span>
    
    </div>
    
        <a href="https://tech.hbc.com/2018-05-07-experimental-reproducibility-in-data-science.html" class="snippet__excerpt__link" title="ODSC Workshop on Experimental Reproducibility in Data Science">
            <p class="snippet__excerpt">
            On May 2nd, we presented at the Open Data Science Conference in Boston, MA. We demonstrated
how to build a machine learning project from scratch with Sacred, an open source
library for experiment tracking, and how to view the results using
Sacredboard.


            </p>
        </a>
    
</section>

        </article>
        
    
        
    
        
            
        <article class="recirc__articles__item">
            


<section class="snippet">

    
    <h1 class="snippet__title">
    <a href="https://tech.hbc.com/2018-03-05-airing-out-a-new-job-system.html" class="snippet__title__link" title="Airing Out A New Job System">
        Airing Out A New Job System
    </a>
    </h1>
    <div class="snippet__meta">
    
        
        
        
            

            
                <a class="meta__category-link" href="https://tech.hbc.com/category/data-science">data science</a>
            

            <span class="slug-divider"></span>
        
    

    
        
            <span class="meta__author">
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Terry McCartan<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            </span>
            <span class="slug-divider"></span>
        
    
    
        <span class="meta__date">MAR 5, 2018</span>
    
    </div>
    
        <a href="https://tech.hbc.com/2018-03-05-airing-out-a-new-job-system.html" class="snippet__excerpt__link" title="Airing Out A New Job System">
            <p class="snippet__excerpt">
            In this article I’ll be sharing some of the knowledge the Data team at HBC Tech picked up in replacing our old job system with Apache Airflow.
We undertook the decision to overhaul our job orchestration system a few months ago due to a number of reasons but have now successfully migrated all our data ingestion jobs to the new system.


            </p>
        </a>
    
</section>

        </article>
        
    
        
            
        <article class="recirc__articles__item">
            


<section class="snippet">

    
    <h1 class="snippet__title">
    <a href="https://tech.hbc.com/2017-08-04-sundial-batch.html" class="snippet__title__link" title="Sundial or AWS Batch, Why not both?">
        Sundial or AWS Batch, Why not both?
    </a>
    </h1>
    <div class="snippet__meta">
    
        
        
        
            

            
                <a class="meta__category-link" href="https://tech.hbc.com/category/data-science">data science</a>
            

            <span class="slug-divider"></span>
        
    

    
        
            <span class="meta__author">
            
                
                <!-- if author exists in site.authors, create link to author's page -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                <!-- render the author name regardless if they're a featured author -->Kevin O'Riordan<!-- if author exists in site.authors, close link to author's page -->
                <!-- add author's job title to give article more clout -->
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            
            </span>
            <span class="slug-divider"></span>
        
    
    
        <span class="meta__date">AUG 4, 2017</span>
    
    </div>
    
        <a href="https://tech.hbc.com/2017-08-04-sundial-batch.html" class="snippet__excerpt__link" title="Sundial or AWS Batch, Why not both?">
            <p class="snippet__excerpt">
            About a year ago, we (the HBC Tech personalization team) open sourced Sundial , a batch job orchestration system leveraging Amazon EC2 Container Service.


            </p>
        </a>
    
</section>

        </article>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
    </div>
</aside>

</article>

</section>
        <footer class="footer">
	<svg class="est1670" xmlns="http://www.w3.org/2000/svg">
		<use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#est1670" ></use>
	</svg>
    <section class="footer__links">
	<ul class="social-links social-links__list">
    <li class="social-links__list-item">
        <a class="social-links__link" target="_blank" rel="next" href="https://www.linkedin.com/company/hbc_digital/">
            <svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg">
                <use class="linkedin"  xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#linkedin"></use>
            </svg>
        </a>
    </li>
    <li class="social-links__list-item">
        <a class="social-links__link" target="_blank" rel="next" href="https://twitter.com/hbctechteam/">
            <svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg">
                <use class="twitter"  xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#twitter"></use>
            </svg>
        </a>
    </li>
    <li class="social-links__list-item">
        <a class="social-links__link" target="_blank" rel="next" href="https://www.instagram.com/hbcdigital">
            <svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg">
                <use class="instagram"  xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://tech.hbc.com/assets/images/hbc-icons.svg#instagram"></use>
            </svg>
        </a>
    </li>
</ul>

	<p class="copyright">&copy; 2019 HBC Tech</i></p>
	</section>
</footer>

        <script type="text/javascript" src="https://tech.hbc.com/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script>
<script type="text/javascript" src="https://tech.hbc.com/assets/js/vendor/jekyll-search-js/fetch.js"></script>
<script type="text/javascript" src="https://tech.hbc.com/assets/js/vendor/jekyll-search-js/search.js"></script>
<script type="text/javascript" src="https://tech.hbc.com/assets/js/main.js"></script>
<script type="text/javascript" src="https://tech.hbc.com/assets/js/vendor/snap/snap.svg-min.js"></script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106560024-1', 'auto');
  ga('send', 'pageview');
</script>


<!-- for netlify cms login redirect -->
<script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          document.location.href = "/admin/";
        });
      }
    });
  }
</script>

    </body>

</html>
