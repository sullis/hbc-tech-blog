<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Revitalize Gilt City&#39;s Order Processing with Serverless Architecture</title><title>Revitalize Gilt City’s Order Processing with Serverless Architecture | HBC Tech</title><meta property="og:title" content="Revitalize Gilt City’s Order Processing with Serverless Architecture"><meta name="author" content="Liyu Ma"><meta property="og:locale" content="en_US"><meta name="description" content="Instant Vouchers Initiative"><meta property="og:description" content="Instant Vouchers Initiative"><link rel="canonical" href="http://tech.hbc.com/2018-01-03-instant-voucher-serverless.html"><meta property="og:url" content="http://tech.hbc.com/2018-01-03-instant-voucher-serverless.html"><meta property="og:site_name" content="HBC Tech"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-01-03T00:00:00-05:00"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@"><meta name="twitter:creator" content="@Liyu Ma"><script type="application/ld+json">{"name":null,"description":"Instant Vouchers Initiative","author":{"@type":"Person","name":"Liyu Ma"},"@type":"BlogPosting","url":"http://tech.hbc.com/2018-01-03-instant-voucher-serverless.html","publisher":null,"image":null,"headline":"Revitalize Gilt City’s Order Processing with Serverless Architecture","dateModified":"2018-01-03T00:00:00-05:00","datePublished":"2018-01-03T00:00:00-05:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://tech.hbc.com/2018-01-03-instant-voucher-serverless.html"},"@context":"http://schema.org"}</script><meta property="og:title" content="Revitalize Gilt City's Order Processing with Serverless Architecture"><meta property="og:type" content="article"><meta property="og:url" content="http://tech.hbc.com//2018-01-03-instant-voucher-serverless.html"><meta property="og:description" content="Instant Vouchers Initiative"><meta property="og:image" content="http://tech.hbc.com/assets/images/blog/hbc-tech-logo-tipi.jpg"><meta property="og:image:secure_url" content="http://tech.hbc.com/assets/images/"><meta property="og:image:type" content="image/jpeg"><meta property="og:image:alt"><link rel="stylesheet" href="http://tech.hbc.com/assets/css/main.css"><link rel="canonical" href="http://tech.hbc.com/2018-01-03-instant-voucher-serverless.html"><link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,700" rel="stylesheet"><link rel="shortcut icon" href="http://tech.hbc.com/assets/images/favicon.ico"></head><body aria-label="Content"><header id="site-header" class="site-header"><div class="site-header__inner"><a class="site-header__logo" href="/"><svg class="hbc-tech-logo" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 64 52"><use class="hbc-tech-logo__text" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#hbc-tech-logo"></use></svg></a><nav id="menu" class="navigation"><svg class="navigation__menu-icon" xmlns="http://www.w3.org/2000/svg"><path class="bar bar__top" d="M0,3 L30,3"></path><path class="bar bar__cross-1" d="M0,14 L30,14"></path><path class="bar bar__cross-2" d="M0,14 L30,14"></path><path class="bar bar__bottom" d="M0,25 L30,25"></path></svg><menu class="menu"><ul class="link-list"><li class="link-list__link-item"><a href="http://tech.hbc.com/" class="link-list__link"><span class="link-list__link-highlight">Insights</span></a></li><li class="link-list__link-item"><a href="http://tech.hbc.com/code" class="link-list__link"><span class="link-list__link-highlight">Code</span></a></li><li class="link-list__link-item"><a href="http://tech.hbc.com/about" class="link-list__link"><span class="link-list__link-highlight">About</span></a></li><li class="link-list__link-item"><a href="http://tech.hbc.com/work-here" class="link-list__link"><span class="link-list__link-highlight">Work Here</span></a></li></ul></menu></nav><search id="header-search" class="header-search"><form class="header-search__form"><input type="text" class="header-search__input" id="header-search-input" placeholder="Search" name="query"></form><svg id="header-search__toggle" class="header-search__svg" xmlns="http://www.w3.org/2000/svg"><path id="leftSearch" class="path path--left-half" d="M11.4842576,23.9891168 C5.09608476,23.7189967 0,18.4546255 0,12 C0,5.54951437 4.85419801,0.113423154 12.4763811,0.0114091479"></path><path id="rightSearch" class="path path--right-half" d="M12.5376167,0.0118279089 C18.9155446,0.293025077 24,5.55274344 24,12 C24,18.4701834 17.7604297,24.3112218 11.1896721,23.9909829"></path><path id="handle" class="path path--handle" d="M20.7485408,20.8914207 L26.8571202,27 L20.7485408,20.8914207"></path></svg><section class="header-search__results" id="header-search__results"></section></search></div></header><section class="content"><article class="article"><header class="article__header article__header--reveal"><h1 class="header-title" title="Revitalize Gilt City's Order Processing with Serverless Architecture">Revitalize Gilt City's Order Processing with Serverless Architecture</h1><span id="no-image-placeholder" class="no-image-placeholder"></span><div class="article-meta"><a href="http://tech.hbc.com/categories/#aws" class="article-meta__category">aws</a> <span class="slug-divider"></span> <span class="article-meta__author">Liyu Ma</span> <span class="slug-divider"></span> <span class="article-meta__date">JAN 3, 2018</span></div></header><section class="article__content article__content--reveal"><div class="article__content__read-time"><span class="read-time" title="Estimated read time"><span class="read-time__text-1">13 min</span> <span class="read-time__text-2">Read</span> <span class="read-time__text-3">Time</span></span></div><div class="article__content__share-buttons"><ul class="share-buttons"><li class="share-buttons__link-item"><a href="https://twitter.com/intent/tweet?text=http://tech.hbc.com//2018-01-03-instant-voucher-serverless.html" class="share-buttons__link" title="Share on Twitter" target="_blank"><svg class="hbc-svg-icon" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon--twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.linkedin.com/shareArticle?mini=true&url=http://tech.hbc.com/&source=/2018-01-03-instant-voucher-serverless.html&title=Revitalize Gilt City's Order Processing with Serverless Architecture" class="share-buttons__link" title="Share on Linkedin" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.facebook.com/sharer/sharer.php?u=http://tech.hbc.com//2018-01-03-instant-voucher-serverless.html" class="share-buttons__link" title="Share on Facebook" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#facebook"></use></svg></a></li><li class="share-buttons__link-item"><a href="https://www.reddit.com/submit?url=http://tech.hbc.com//2018-01-03-instant-voucher-serverless.html" class="share-buttons__link" title="Share on Reddit" target="_blank"><svg height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#reddit"></use></svg></a></li></ul></div><div class="article__content__body"><h1 id="instant-vouchers-initiative">Instant Vouchers Initiative</h1><p><a href="https://www.gilt.com/city/">Gilt City</a> is Gilt’s high-end voucher portal that offers localised discounts on exclusive lifestyle experiences in dining, entertainment, beauty, fitness etc to our 3.4 million members across 13 U.S. cities. Gilt City’s legacy order processing backend is a scheduled-job based architecture in which functionality such as fraud scan, payment authorisation, order fulfillment are assigned to independent jobs that process orders in batches according to order status. Though this architecture can scale to meet peak time workload and provides some level of resilience (failed orders are retried the next time the job runs), it inevitably includes some idle time i.e. wait for the next job to pick up an order from the previous job. The resulting average processing time could add up to 15 minutes.</p><p>Since many of Gilt City’s offers are of an impulsive nature and time-sensitive, long processing time becomes a clear bottleneck to user experience. Team Marconi in Gilt have been driving the work on the Instant Vouchers Initiative for the past few months ago, in an effort to re-architect the backend of order processing using the latest cloud technologies. We believe that by reducing this wait time, it will significantly boost overall shopping experience and enable immediate use of vouchers and, in turn, it allows for new features such as location-based push notifications.</p><h1 id="an-event-driven-serverless-architecture">An Event Driven, Serverless Architecture</h1><p>It is never easy to rewrite (or replace) a mission critical system. In our case, we have to keep the existing monolithic Ruby on Rails app running while spinning up a new pipeline. We took the strangler pattern (see this <a href="https://martinfowler.com/bliki/StranglerApplication.html">Martin Fowler article</a> for an explanation) and built a new API layer for processing individual orders around the existing batch-processing, job-based system in the same Rails app. With this approach, the legacy job-based system gradually receives less traffic and becomes a fallback safety net to catch and retry failed orders from the instant processing pipeline.</p><p>The new instant order pipeline starts with the <strong>checkout system</strong> publishing a notification to an SNS topic whenever it creates an order object. An order notification contains the order ID to allow event subscribers to look up the order object in the order key-value store. An AWS Lambda application <strong>order-notification-dispatcher</strong> subscribes to this SNS topic and kicks off the processing by invoking an AWS Step Functions resource. See below a simplified architecture diagram of the order processing system.</p><p>The architecture leverages Lambda and Step Functions from the AWS Serverless suite to build several key components. At HBC, different teams have started embracing a serverless paradigm to build production applications. There are many benefits of adopting a serverless paradigm, such as abstraction from infrastructure, out-of-the-box scalability, and an on-demand cost model just to name a few. Compared to the alternative of building and maintaining an array of EC2/container instances, a serverless architecture goes a step beyond microservices to allow an even faster development iteration cycle. With the use of Step Functions as an orchestration engine, it is much easier to facilitate interaction between Lambda applications.</p><p><img src="https://i.imgur.com/2FYlarr.png" alt="alt text" title="Instant Order Processing Architecture"></p><h1 id="aws-step-functions-for-lambda-orchestration">AWS Step Functions for Lambda Orchestration</h1><p>As mentioned above, AWS Step Functions is an orchestration service that makes it easy to coordinate stateless Lambda applications by establishing a specification to transition application states. Behind the scenes, it is depicted as a state machine constructed with the JSON-based <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html">Amazon States Language</a>. See below a sample execution from the order-processing step function.</p><p><img src="https://i.imgur.com/RWakgNC.png" alt="alt text" title="An successful Step Function execution example"></p><h3 id="inside-step-functions">Inside Step Functions</h3><p>At the top level the specification includes various types of <a href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-states.html">States</a>, such as <code class="highlighter-rouge">Task</code>, <code class="highlighter-rouge">Choice</code> and <code class="highlighter-rouge">Wait</code>, to be used to compose simple business logic to transition application state. Inside a <code class="highlighter-rouge">Task</code> State, an AWS Lambda ARN can be specified to be invoked. The output of the Lambda will be directed as input to next State. This is an excerpt from the order-processing state machine:</p><div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"Comment"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Order processing state machine"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"StartAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ChangeOrderStatus"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"States"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"ChangeOrderStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Task"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:lambda:us-east-1:1234567890:function:start-order-processing:2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"TimeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FraudScan"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"FraudScan"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Task"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:lambda:us-east-1:1234567890:function:fraud-scan:2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"TimeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">      
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IsFraudOrder"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"IsFraudOrder"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Choice"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Choices"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.fraud_verdict"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleared"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuthorizePayment"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
          </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.fraud_verdict"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fraud"</span><span class="p">,</span><span class="w">
          </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FraudOrderTerminal"</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="err">...</span><span class="w">
      </span><span class="p">]</span><span class="w">      
    </span><span class="p">},</span><span class="w">    
    </span><span class="nt">"AuthorizePayment"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Task"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:lambda:us-east-1:1234567890:function:authorize-payments:2"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"TimeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">      
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WarehouseChoice"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"FraudOrderTerminal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pass"</span><span class="p">,</span><span class="w">      
      </span><span class="nt">"Result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This is the ending state for a fraud order"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"End"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="err">...</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h3 id="polling-and-retry-on-errors">Polling and Retry on Errors</h3><p>A serverless paradigm fits really well in situations where computation completes within a short time (ideally seconds). However, sometimes we still need to run a task that will take slightly longer. For example, in our pipeline, we need to keep polling a service endpoint for a fraud-scan result, since it is an async process. We implemented this by defining a retry counter <code class="highlighter-rouge">get_fraud_status_retries</code> within a <code class="highlighter-rouge">Choice</code> state and set a max attempt count of 60 to terminate retries.</p><div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="s2">"IsFraudOrder"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Choice"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"Choices"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.fraud_verdict"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleared"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AuthorizePayment"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.fraud_verdict"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"StringEquals"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fraud"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FraudOrderTerminal"</span><span class="w">
    </span><span class="p">},</span><span class="w">        
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.get_fraud_status_retries"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"NumericLessThanEquals"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FraudScanWait"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"Variable"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$.get_fraud_status_retries"</span><span class="p">,</span><span class="w">
      </span><span class="nt">"NumericGreaterThan"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FraudStatusUnavailableTerminal"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">      
</span><span class="p">}</span><span class="w">
</span></code></pre></div><p>It is also critical to make cloud applications resilient to errors such as network timeouts. Step Functions provides error handling to allow catching/retrying of some predefined errors as well as customised Lambda error types. You can specify different retry strategies with properties such as <code class="highlighter-rouge">MaxAttempts</code> and <code class="highlighter-rouge">BackoffRate</code>. See the below example where we implemented a retry mechanism for different errors in the <code class="highlighter-rouge">Task</code> state to create redemption codes:</p><div class="language-json highlighter-rouge"><pre class="highlight"><code><span class="s2">"CreateRedemptionCode"</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nt">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Task"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:lambda:us-east-1:1234567890:function:create-redemption-code:3"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"TimeoutSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"FulfillElectronicOrder"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"Retry"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"ErrorEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"GatewayTimeoutError"</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nt">"IntervalSeconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nt">"MaxAttempts"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nt">"Catch"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">            
    </span><span class="p">{</span><span class="w">
      </span><span class="nt">"ErrorEquals"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"States.ALL"</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nt">"Next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CatchMissingRedemptionCode"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h1 id="immutable-deployment--partial-rollout">Immutable Deployment &amp; Partial Rollout</h1><p>Deploying a mission critical service to a production environment is always a nervous process. At HBC we advocate immutable deployments whenever possible and leverage A/B testing to help us roll out new features to customers in a gradual manner. In a serverless world, it is a little different, since most of the infrastructure management is abstracted away.</p><h3 id="lambda-versioning">Lambda Versioning</h3><p>AWS Lambda’s <a href="https://docs.aws.amazon.com/lambda/latest/dg/versioning-aliases.html">versioning feature</a> provides the ability to make Lambda functions immutable by taking a snapshot of the function (aka publishing a version). We really like this, since it ensures the Lambda function artifact as well as environment variables remain immutable once published. Note that in the above code snippets of state machine JSON, the ARN specified for each Lambda resource is Lambda version ARN instead of function ARN. We also use Lambda’s <a href="https://docs.aws.amazon.com/lambda/latest/dg/aliases-intro.html">aliasing feature</a> to have a <code class="highlighter-rouge">prod</code> alias mapped to the current production version, with immutable environment variables:</p><p><img src="https://i.imgur.com/Rj7UeTy.png" alt="alt text" title="Lambda Alias Mapping"></p><p>With aliasing we can easily roll back to a previous Lambda version in case of an unexpected production failure.</p><h3 id="bluegreen-stacks">Blue/Green Stacks</h3><p>So we have immutable Lambda functions, but we still want to make our Step Functions (SF) immutable. We decided to create a new SF resource every time we release it, meanwhile the old SF resource remains unchanged. Since AWS does not currently provide a versioning feature for Step Functions, we included semantic versioning in the SF name e.g. <code class="highlighter-rouge">order-processing-v0.0.6</code>. With both new and old versions (including historical SFs) we are able to apply a blue/green deployment and rollback procedure.</p><p>To route orders to either blue/green stack, we make the <strong>order-notification-dispatcher</strong> Lambda the de facto router by providing blue/green versions of SF as its <a href="https://docs.aws.amazon.com/lambda/latest/dg/env_variables.html">environment variables</a>. Here is the Node.js code to read the stack environment variables:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">stateMachineBlueVer</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STATE_MACHINE_BLUE_VER</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">stateMachineGreenVer</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">STATE_MACHINE_GREEN_VER</span><span class="p">;</span>
</code></pre></div><p>With fetched state machine stack version we can compose Step Function ARN with predefined format, then start a new execution with AWS sdk Step Function api:</p><div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">stateMachineVersion</span> <span class="o">=</span> <span class="p">...</span> <span class="c1">// Read from environment vars</span>
<span class="kd">function</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">orderJson</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="nx">orderJson</span><span class="p">.</span><span class="nx">order_id</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">stateMachine</span> <span class="o">=</span> <span class="nx">preProcessingStepFunctionPrefix</span> <span class="o">+</span> <span class="nx">stateMachineVersion</span><span class="p">;</span> 
  <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">stateMachineArn</span><span class="p">:</span> <span class="nx">stateMachine</span><span class="p">,</span>
    <span class="na">name</span><span class="p">:</span> <span class="nx">orderId</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
    <span class="na">input</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">orderJson</span><span class="p">)</span>
  <span class="p">};</span>  
  <span class="k">return</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">StepFunctions</span><span class="p">().</span><span class="nx">startExecution</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nx">promise</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div><h3 id="partial-rollout">Partial Rollout</h3><p>We make the <strong>order-notification-dispatcher</strong> query our a/b test engine to have simple routing logic for each order notification, so that it can shift traffic to either the blue/green Step Function stack according to test/control group the order falls into. Also note that AWS recently released a nice <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-traffic-shifting-using-aliases.html">traffic shifting</a> feature for Lambda applications. However, we didn’t use it as our a/b test engine provides finer-grain control which allows us to target certain groups such as HBC’s internal employees. Here is a diagram depicting the partial rollout process for new Step Function resources:</p><p><img src="https://i.imgur.com/ZSyvoJ1.png" alt="alt text" title="Partial Rollout Process"></p><h1 id="conclusion">Conclusion</h1><h3 id="what-we-have-achieved">What We Have Achieved</h3><p>As of today all of Gilt City’s orders have been directed to the instant processing pipeline, which shortens the majority of orders’ processing time from over 15 minutes to a few seconds. We are looking to expand the system to take over more workload including physical products to bring the instant order user experience to a wider customer base.</p><h3 id="step-functions-limitations">Step Functions Limitations</h3><p>From our development exerience using AWS Step Functions we discovered some limitations of this service. First of all, it lacks of a feature like a <code class="highlighter-rouge">Map</code> state which would take a list of input objects and transform it to another list of result objects. A possible solution could be allowing invocation of a sub SF multiple times. In our case, an order object can be split into multiple order objects depending on the items in the original order. Unfortuntely SF does not offer a State type that can map a dynamic number of elements. We eventually made the workaround by creating an <strong>order-pre-processing</strong> SF and make it invoke the <strong>order-processing</strong> SF multiple times to process those ‘split’ orders.</p><p>Secondly, we hope AWS can provide versioning/aliasing for Step Functions so we can gain immutability out of the box instead of forcing immutability on our side. Any support for blue/green deployment would be even better.</p><p>Also, we expect AWS to provide better filtering/searching abilities on the Step Functions dashboard so we can gain some fundamental data analytics from historical executions. This could be obtained by declaring some “searchable” fields and relative types in the SF definition.</p><p>In the context of AWS Enterprise Support, we (Team Marconi) had a productive meeting directly with the AWS Step Functions Product Manager during which we have suggested our list of improvements. It was gratifying to hear that most of these are already or will be included in their development roadmap.</p><h3 id="future-work">Future Work</h3><p>From an architecture perspective, we are trying to standardize a continous delivery process for our serverless components. At the moment, what we have is “poor man’s CI/CD” - some bash/node scripts which use AWS CloudFormation SDK to provision resources. There are various tools available either from AWS or the serverless community such as <a href="https://www.terraform.io/">Terraform</a>, <a href="https://aws.amazon.com/documentation/codepipeline/">CodePipeline</a> that we are trying to integrate with to provide a frictionless path to production.</p></div><footer class="article__content__footer"><div class="article-tags"><span class="article-tags__tag">aws</span><span>,</span> <span class="article-tags__tag">serverless</span><span>,</span> <span class="article-tags__tag">lambda</span><span>,</span> <span class="article-tags__tag">step function</span><span>,</span> <span class="article-tags__tag">gilt city</span><span>,</span> <span class="article-tags__tag">order processing</span></div><section class="author-bio"><svg class="author-bio__avatar" height="36" width="36" xmlns="http://www.w3.org/2000/svg"><use class="hbc-svg-icon hbc-svg-icon--avatar__circle" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#circle"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__head" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#head"></use><use class="hbc-svg-icon hbc-svg-icon--avatar__body" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#body"></use></svg><span class="author-bio__name">Liyu Ma</span></section></footer></section><aside class="recirc"><h2 class="header__title">Recent Insights</h2><span class="slug-divider"></span> <a class="header__view-all-link" href="http://tech.hbc.com/categories/index.html">See All</a><div class="recirc__articles"><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="http://tech.hbc.com/2018-01-16-sundial-aws-emr-integration.html" class="snippet__title__link" title="Sundial AWS EMR Integration">Sundial AWS EMR Integration</a></h1><div class="snippet__meta"><a class="meta__category-link" href="http://tech.hbc.com/categories/#aws">aws</a> <span class="slug-divider"></span> <span class="meta__author"><a class="meta__author-link" href="http://tech.hbc.com/authors/giovanni-gargiulo">Giovanni Gargiulo</a><span class="meta__author__job-title">, Staff Engineer</span></span> <span class="slug-divider"></span> <span class="meta__date">JAN 16, 2018</span></div><a href="http://tech.hbc.com/2018-01-16-sundial-aws-emr-integration.html" class="snippet__excerpt__link" title="Sundial AWS EMR Integration"><p class="snippet__excerpt">AWS Elastic Map Reduce on Sundial</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="http://tech.hbc.com/2015-04-16-tips-for-debugging-ec2-container-service.html" class="snippet__title__link" title="Tips for Debugging EC2 Container Service">Tips for Debugging EC2 Container Service</a></h1><div class="snippet__meta"><a class="meta__category-link" href="http://tech.hbc.com/categories/#aws">aws</a> <span class="slug-divider"></span> <span class="meta__author">Scott Thompson</span> <span class="slug-divider"></span> <span class="meta__date">APR 16, 2015</span></div><a href="http://tech.hbc.com/2015-04-16-tips-for-debugging-ec2-container-service.html" class="snippet__excerpt__link" title="Tips for Debugging EC2 Container Service"><p class="snippet__excerpt">Last week, Amazon made their Elastic Container Service generally available and also released a web UI to make it easier to create tasks. This service was exciting for our personalization team as we wanted to leverage ECS to simplify deployment of our jobs and have better control over failures.Getting started with ECS is easy but requires your full attention because there are a lot of important details (did you remember to...</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="http://tech.hbc.com/2018-01-26-aws-sdk-for-java.html" class="snippet__title__link" title="AWS SDK for Java, version 2.0">AWS SDK for Java, version 2.0</a></h1><div class="snippet__meta"><a class="meta__category-link" href="http://tech.hbc.com/categories/#cloud">cloud</a> <span class="slug-divider"></span> <span class="meta__author">Sean Sullivan</span> <span class="slug-divider"></span> <span class="meta__date">JAN 26, 2018</span></div><a href="http://tech.hbc.com/2018-01-26-aws-sdk-for-java.html" class="snippet__excerpt__link" title="AWS SDK for Java, version 2.0"><p class="snippet__excerpt">The Capital Region AWS User Group met on January 18th at the Nanotech Complex in Albany New York. CommerceHub hosted the meeting at their main office.</p></a></section></article><article class="recirc__articles__item"><section class="snippet"><h1 class="snippet__title"><a href="http://tech.hbc.com/2018-01-24-career-structure.html" class="snippet__title__link" title="Career Structure. It doesn't matter. Until it matters.">Career Structure. It doesn't matter. Until it matters.</a></h1><div class="snippet__meta"><a class="meta__category-link" href="http://tech.hbc.com/categories/#leadership">leadership</a> <span class="slug-divider"></span> <span class="meta__author">Adrian Trenaman</span> <span class="slug-divider"></span> <span class="meta__date">JAN 24, 2018</span></div><a href="http://tech.hbc.com/2018-01-24-career-structure.html" class="snippet__excerpt__link" title="Career Structure. It doesn't matter. Until it matters."><p class="snippet__excerpt">In this article, I’m going to talk about career structure, career development, and career titles in a tech organisation. This post is more about organisational development than it is about technology; however, on the grounds that the health of your architecture and technology choices will be somewhat isomorphic to the health of your organisation, I believe this to be a worthwhile read for any engineering leader. I’m also writing this...</p></a></section></article></div></aside></article></section><footer class="footer"><svg class="est1670" xmlns="http://www.w3.org/2000/svg"><use class="hbc-tech-logo__use" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#est1670"></use></svg><section class="footer__links"><ul class="social-links social-links__list"><li class="social-links__list-item"><a class="social-links__link" target="_blank" rel="next" href="https://www.linkedin.com/company/hbc_digital/"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="linkedin" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#linkedin"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" target="_blank" rel="next" href="https://twitter.com/hbcdigital/"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="twitter" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#twitter"></use></svg></a></li><li class="social-links__list-item"><a class="social-links__link" target="_blank" rel="next" href="https://www.instagram.com/hbcdigital"><svg class="social-links__icon" xmlns="http://www.w3.org/2000/svg"><use class="instagram" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://tech.hbc.com/assets/images/hbc-icons.svg#instagram"></use></svg></a></li></ul><p class="copyright">&copy; 2018 HBC Tech</p></section></footer><script type="text/javascript" src="http://tech.hbc.com/assets/js/vendor/scrollmagic/ScrollMagic.min.js"></script><script type="text/javascript" src="http://tech.hbc.com/assets/js/vendor/jekyll-search-js/fetch.js"></script><script type="text/javascript" src="http://tech.hbc.com/assets/js/vendor/jekyll-search-js/search.js"></script><script type="text/javascript" src="http://tech.hbc.com/assets/js/main.js"></script><script type="text/javascript" src="http://tech.hbc.com/assets/js/vendor/snap/snap.svg-min.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106560024-1', 'auto');
  ga('send', 'pageview');
</script></body></html>